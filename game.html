<!DOCTYPE html>
<html>
<head>
    <title>Pose Game</title>
    <style>
        #container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #game-info {
            display: flex;
            justify-content: space-between;
            width: 640px;
            margin-bottom: 10px;
        }
        #webcam-container {
            position: relative;
            width: 640px;
            height: 480px;
        }
        #webcam, #canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        #label-container {
            margin-top: 10px;
        }
        #selected-label-container {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
        #probability-bar {
            width: 0;
            height: 20px;
            background-color: green;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="game-info">
            <div id="score">Score: 0</div>
            <div id="timer">Time: 180</div>
        </div>
        <div id="webcam-container">
            <video id="webcam" width="640" height="480" autoplay playsinline></video>
            <canvas id="canvas" width="640" height="480"></canvas>
        </div>
        <div id="label-container"></div>
        <div id="selected-label-container">
            <div>Selected Label: <span id="selected-label"></span></div>
            <div id="probability-bar-container">
                <div id="probability-bar"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
    <script type="text/javascript">
        // More code will go here
        const URL_PARAM = new URLSearchParams(window.location.search);
        const MODEL_URL = URL_PARAM.get('modelUrl');

        let model, webcam, ctx, labelContainer, selectedLabel, probabilityBar;
        let score = 0;
        let timeLeft = 180;
        let labels = [];
        let selectedLabelName = null;
        let completedLabels = [];

        const scoreElement = document.getElementById('score');
        const timerElement = document.getElementById('timer');

        async function init() {
            if (!MODEL_URL) {
                alert("Model URL not found!");
                window.location.href = "init.html";
                return;
            }

            const modelURL = MODEL_URL + "model.json";
            const metadataURL = MODEL_URL + "metadata.json";

            try {
                model = await tmPose.load(modelURL, metadataURL);
                labels = model.getClassLabels();
            } catch (e) {
                console.error(e);
                alert("Failed to load model. Please check the URL and try again.");
                window.location.href = "init.html";
                return;
            }

            const size = 400;
            const flip = true; 
            webcam = new tmPose.Webcam(size, size, flip); 
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);

            const canvas = document.getElementById("canvas");
            canvas.width = size;
            canvas.height = size;
            ctx = canvas.getContext("2d");
            labelContainer = document.getElementById("label-container");
            selectedLabel = document.getElementById("selected-label");
            probabilityBar = document.getElementById("probability-bar");

            renderLabels();
            startTimer();
        }

        function renderLabels() {
            labelContainer.innerHTML = "";
            labels.forEach(label => {
                const button = document.createElement("button");
                button.innerText = label;
                button.disabled = completedLabels.includes(label);
                if (completedLabels.includes(label)) {
                    button.style.backgroundColor = "grey";
                }
                button.addEventListener("click", () => selectLabel(label));
                labelContainer.appendChild(button);
            });
        }

        function selectLabel(label) {
            selectedLabelName = label;
            selectedLabel.innerText = label;
        }

        function startTimer() {
            const timerInterval = setInterval(() => {
                timeLeft--;
                timerElement.innerText = `Time: ${timeLeft}`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        async function loop() {
            webcam.update(); 
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const {
                pose,
                posenetOutput
            } = await model.estimatePose(webcam.canvas);
            const prediction = await model.predict(posenetOutput);

            if (selectedLabelName) {
                const selectedPrediction = prediction.find(p => p.className === selectedLabelName);
                if (selectedPrediction) {
                    const probability = selectedPrediction.probability;
                    probabilityBar.style.width = `${probability * 100}%`;

                    if (probability > 0.7) {
                        score++;
                        scoreElement.innerText = `Score: ${score}`;
                        completedLabels.push(selectedLabelName);
                        selectedLabelName = null;
                        selectedLabel.innerText = "";
                        probabilityBar.style.width = "0%";
                        renderLabels();
                        
                        if (completedLabels.length === labels.length) {
                            endGame();
                        }
                    }
                }
            }

            drawPose(pose);
        }

        function drawPose(pose) {
            if (webcam.canvas) {
                ctx.drawImage(webcam.canvas, 0, 0);
                if (pose) {
                    const minPartConfidence = 0.5;
                    tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
                    tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
                }
            }
        }
        
        function endGame() {
            const bonus = Math.floor(timeLeft / 10) * 0.1;
            const finalScore = score + bonus;
            window.location.href = `score.html?score=${finalScore}`;
        }

        init();
    </script>
</body>
</html>